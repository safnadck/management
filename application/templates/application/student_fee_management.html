{% load static %}
{% load permission_tags %} 
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Franchise - {{ franchise.name }}</title>
    <link rel="stylesheet" href="{% static 'css/student_fee_management.css' %}">
    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
</head>

<body>

    <!-- Navbar -->
    <header class="navbar">
        <a href="{% url 'application:homepage' %}" class="navbar-left">
            <img src="{% static 'images/tutorlogo.png' %}" alt="Tutor Logo" class="brand-logo">
        </a>

        <div class="user-panel">
            <span class="iconify profile" data-icon="iconamoon:profile-fill"></span>
            <span class="user-name">Admin</span>
            <div class="dropdown-menu">
                <a href="{% url 'logout' %}" class="logout-link">Logout</a>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
  <aside class="sidebar-menu">
    <div class="menu-wrapper">
      {% if show_reports_button %}
      <div class="menu-item">
        <a href="{% url 'application:homepage' %}" class="menu-link">
          <span class="iconify menu-icon" data-icon="iconoir:reports-solid"></span>
          <span class="menu-text">Reports</span>
        </a>
      </div>
      {% endif %}
      {% if show_franchise_button %}
      <div class="menu-item">
        <a href="{% url 'application:franchise_list' %}" class="menu-link">
          <span class="iconify menu-icon" data-icon="fa-solid:school"></span>
          <span class="menu-text">Franchise</span>
        </a>
      </div>
      {% endif %}
      {% if show_receipt_button %}
      <div class="menu-item">
        <a href="{% url 'application:receipt_search' %}" class="menu-link">
          <span class="iconify menu-icon" data-icon="fluent:reciept-24-filled"></span>
          <span class="menu-text">Reciept</span>
        </a>
      </div>
      {% endif %}
    </div>
  </aside>

    <!-- Main Content -->
    <main class="page-content">
        <div class="register-wrapper">
            <div class="left-buttons">
                <a href="{% url 'application:student_detail' franchise.id batch.id user.id %}" class="backbutton">
                    <span class="iconify" data-icon="weui:back-filled" style="font-size: 20px;"></span>
                </a>
                   <button class="sidebar-toggle">
      <span class="iconify" data-icon="mdi:menu" style="font-size: 20px;"></span>
        </button>
            </div>
        </div>

        
        <!-- Franchise and Batch Information -->
        <div class="franchise-batch-section">
            <h2>Batch fee Details</h2>
            <div class="info-grid">
                <div class="info-item">
                    <label>Batch Fees:</label>
                    <span>₹{{ batch.fees }}</span>
                </div>
                <div class="info-item">
                    <label>Discount:</label>
                    <span>₹{{ student_fee.discount }}</span>
                </div>
                <div class="info-item">
                    <label>Net Payable Amount:</label>
                    <span>₹{{ student_fee.remaining_amount }}</span>
                </div>
            </div>
        </div>

        <!-- Fee Management Section -->
        <div class="fee-management-section">
            <h2>Fee Management</h2>
            <div class="fee-summary">
                <h3>Fee Summary</h3>
                <p><strong>Total Pending:</strong> ₹<span id="total-pending">{{ total_pending }}</span></p>
            </div>

            <table class="fee-table" id="installments-table">
                <thead>
                    <tr>
                        <th>Installment Due Date</th>
                        <th>Amount</th>
                         <th>paid within(days)</th>
                        <th>Paid Amount</th>

                        <th>Status</th>
                        <th>Payment Date</th>
                        <th>Print Invoice</th>
                    </tr>
                </thead>
                <tbody id="installments-tbody">
                    {% for item in installments %}
                        {% with installment=item.installment %}
                        <tr class="installment-row">
                            <td>{{ installment.due_date|date:'d/m/Y' }}</td>
                            <td>{{ installment.amount }}</td>
                            <td>{{ item.repayment_period_days }}</td>
                            <td class="payed-amount">
                                {{ installment.payed_amount }}
                            </td>

                            <td>
                                {% if installment.status == "paid" %}
                                    <span>Paid</span>
                                {% else %}
                                    <span>{{ installment.status|title }}</span>
                                {% endif %}
                            </td>
                            <td>{% if installment.payment_date %}{{ installment.payment_date|date:'d/m/Y' }}{% else %}-{% endif %}</td>
                            <td>
                                {% if installment.status == "paid" %}
                                    <a href="{% url 'application:print_installment_invoice' franchise_pk=franchise.id batch_pk=batch.id user_pk=user.id installment_pk=installment.id %}" target="_blank" class="print-invoice-btn"> <span class="iconify menu-icon" data-icon="material-symbols-light:print-rounded"></span></a>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endwith %}
                    {% endfor %}
                </tbody>
            </table>

            <div class="form-actions">
                <a href="{% url 'application:edit_installment_setup' franchise_pk=franchise.id batch_pk=batch.id user_pk=user.id %}" class="btn-secondary">Edit Installment</a>
            </div>
        </div>
    </main>


<script>
    const userPanel = document.querySelector('.user-panel');
    const dropdownMenu = document.querySelector('.dropdown-menu');
    const sidebar = document.querySelector('.sidebar-menu');
    const toggleButton = document.querySelector('.sidebar-toggle');


    // Toggle dropdown on click
    userPanel.addEventListener('click', function(event) {
      event.stopPropagation(); // prevent click from bubbling
      dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function() {
      dropdownMenu.style.display = 'none';
    });

     // Toggle sidebar on button click
    toggleButton.addEventListener('click', function() {
      sidebar.classList.toggle('sidebar-open');
      const icon = toggleButton.querySelector('.iconify');
      if (sidebar.classList.contains('sidebar-open')) {
        icon.setAttribute('data-icon', 'mdi:close');
      } else {
        icon.setAttribute('data-icon', 'mdi:menu');
      }
    });
</script>


</body>
</html>
